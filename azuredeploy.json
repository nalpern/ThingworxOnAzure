{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "vnetName": {
            "type": "string",
            "defaultValue": "myVirtualNetwork",
            "metadata": {
                "description": "The name of your VNET"
            }
        },
        "vnetAddressPrefix": {
            "type": "string",
            "defaultValue": "10.0.0.0/16",
            "metadata": {
                "description": "VNET Address prefix"
            }
        },
        "subnetParam": {
            "type": "object",
            "metadata": {
                "description": "VNET Subnet JSON"
            }
        },
        "nsgParam": {
            "type": "object",
            "metadata": {
                "description": "NSG JSON"
            }
        },
        "storageAccountName": {
            "type": "string",
            "defaultValue": "howsaddatwxtest01",
            "metadata": {
                "description": "The storage account name"
            }
        },
        "cosmosDbName": {
            "type": "string",
            "defaultValue": "how-cosmos-dda-twxtest01",
            "metadata": {
                "description": "The CosmosDB account name"
            }
        },
        "streamAnalyticsName": {
            "type": "string",
            "defaultValue": "HOW-STREAM-TEST01",
            "metadata": {
                "description": "The Stream Analytics account name"
            }
        },
        "postgresqlName": {
            "type": "string",
            "defaultValue": "how-pgsql-twxtest-01",
            "metadata": {
                "description": "The PostgreSQL account name"
            }
        },
        "postgresqlAdminLogin": {
            "type": "string",
            "defaultValue": "sqlAdmin",
            "metadata": {
                "description": "The PostgreSQL admin username"
            }
        },
        "postgresqlAdminPassword": {
            "type": "securestring",
            "defaultValue": "MyS3re@tPassw0rd",
            "metadata": {
                "description": "The PostgreSQL admin password"
            }
        },
        "iotHubName": {
            "type": "string",
            "defaultValue": "HOW-IOTHUB-TWXTEST-01",
            "metadata": {
                "description": "The IOT account name"
            }
        },
        "availibilitySets": {
            "type": "array",
            "metadata": {
                "description": "An array of availibility set names"
            }
        },
        "vmParam": {
            "type": "object",
            "metadata": {
                "description": "VM configuration JSON"
            }
        }        
    },
    "resources": [
        {
            "apiVersion": "2017-05-10",
            "name": "linkedNSG",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/kwhitehall/ThingworxOnAzure/master/nested/azuredeploy.nsg.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "nsgParam": {
                        "value": "[parameters('nsgParam')]"
                    }
                }
            }
        },
        {
            "apiVersion": "2017-05-10",
            "name": "linkedVNET",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/kwhitehall/ThingworxOnAzure/master/nested/azuredeploy.vnet.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "vnetName": {
                        "value": "[parameters('vnetName')]"
                    },
                    "vnetAddressPrefix": {
                        "value": "[parameters('vnetAddressPrefix')]"
                    }
                }
            }
        },
        {
            "apiVersion": "2017-05-10",
            "name": "linkedSubnet",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/kwhitehall/ThingworxOnAzure/master/nested/azuredeploy.subnet.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "vnetName": {
                        "value": "[parameters('vnetName')]"
                    },
                    "subnetParam": {
                        "value": "[parameters('subnetParam')]"
                    }
                }
            },
            "dependsOn": [
                "linkedVNET"
            ]
        },
        {
            "apiVersion": "2017-05-10",
            "name": "linkedStorage",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/kwhitehall/ThingworxOnAzure/master/nested/azuredeploy.storage.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "storageAccountName": {
                        "value": "[parameters('storageAccountName')]"
                    }
                }
            },
            "dependsOn": []
        },
        {
            "apiVersion": "2017-05-10",
            "name": "linkedCosmosDB",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/kwhitehall/ThingworxOnAzure/master/nested/azuredeploy.cosmosdb.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "cosmosDbName": {
                        "value": "[parameters('cosmosDbName')]"
                    }
                }
            },
            "dependsOn": []
        },
        {
            "apiVersion": "2017-05-10",
            "name": "linkedStreamAnalytics",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/kwhitehall/ThingworxOnAzure/master/nested/azuredeploy.streamanalytics.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "streamAnalyticsName": {
                        "value": "[parameters('streamAnalyticsName')]"
                    }
                }
            },
            "dependsOn": []
        },
        {
            "apiVersion": "2017-05-10",
            "name": "linkedPostgreSQL",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/kwhitehall/ThingworxOnAzure/master/nested/azuredeploy.postgresql.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "postgresqlName": {
                        "value": "[parameters('postgresqlName')]"
                    },
                    "postgresqlAdminLogin": {
                        "value": "[parameters('postgresqlAdminLogin')]"
                    },
                    "postgresqlAdminPassword": {
                        "value": "[parameters('postgresqlAdminPassword')]"
                    }
                }
            },
            "dependsOn": []
        },
        {
            "apiVersion": "2017-05-10",
            "name": "linkedIOTHub",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/kwhitehall/ThingworxOnAzure/master/nested/azuredeploy.iothub.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "iotHubName": {
                        "value": "[parameters('iotHubName')]"
                    }
                }
            },
            "dependsOn": []
        },
        {
            "apiVersion": "2017-05-10",
            "name": "linkedAvailibilitySets",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/kwhitehall/ThingworxOnAzure/master/nested/azuredeploy.availibilitySets.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "availibilitySets": {
                        "value": "[parameters('availibilitySets')]"
                    }
                }
            },
            "dependsOn": []
        },
        {
            "apiVersion": "2017-05-10",
            "name": "linkedVMPublicIP",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/kwhitehall/ThingworxOnAzure/master/nested/azuredeploy.vm-public-ip.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "vmParam": {
                        "value": "[parameters('vmParam')]"
                    },
                    "storageAccountName": {
                        "value": "[parameters('storageAccountName')]"
                    },
                    "vnetName": {
                        "value": "[parameters('vnetName')]"
                    }
                }
            },
            "dependsOn": []
        },
        {
            "apiVersion": "2017-05-10",
            "name": "linkedVMNIC",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/kwhitehall/ThingworxOnAzure/master/nested/azuredeploy.vm-nic.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "vmParam": {
                        "value": "[parameters('vmParam')]"
                    },
                    "storageAccountName": {
                        "value": "[parameters('storageAccountName')]"
                    },
                    "vnetName": {
                        "value": "[parameters('vnetName')]"
                    }
                }
            },
            "dependsOn": ["linkedSubnet","linkedVMPublicIP"]
        },
        {
            "apiVersion": "2017-05-10",
            "name": "linkedVM",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/kwhitehall/ThingworxOnAzure/master/nested/azuredeploy.vm.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "vmParam": {
                        "value": "[parameters('vmParam')]"
                    },
                    "storageAccountName": {
                        "value": "[parameters('storageAccountName')]"
                    },
                    "vnetName": {
                        "value": "[parameters('vnetName')]"
                    }
                }
            },
            "dependsOn": ["linkedAvailibilitySets","linkedVMNIC"]
        }
    ],
    "outputs": {}
}